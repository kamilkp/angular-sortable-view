/*
	Copyright Kamil PÄ™kala http://github.com/kamilkp
	angular-sortable-view v0.0.13 2015/01/13
*/
!function(a,b){"use strict";function c(a){if(!("clientX"in a||"clientY"in a)){var b=a.touches||a.originalEvent.touches;b&&b.length&&(a.clientX=b[0].clientX,a.clientY=b[0].clientY),a.preventDefault()}}function d(a){if(a=a[0],a.previousElementSibling)return b.element(a.previousElementSibling);for(var c=a.previousSibling;null!=c&&1!=c.nodeType;)c=c.previousSibling;return b.element(c)}function e(a,b){var c=d(a);c.length>0?c.after(b):a.parent().prepend(b)}function f(a,c){if(a instanceof b.element&&(a=a[0]),null!==j)return a[j](c)}function g(){var a=document;return a.scrollingElement?a.scrollingElement:a.documentElement.scrollHeight>a.body.scrollHeight&&0==a.compatMode.indexOf("CSS1")?a.documentElement:a.body}var h=b.module("angular-sortable-view",[]);h.directive("svRoot",["svProvider",function(a){function b(a,b,c){return c?a.x-b.x<0:a.y-b.y<0}function c(a){return j[a]}function d(a){delete j[a]}function g(a){return[{x:a.left,y:a.top},{x:a.left+a.width,y:a.top},{x:a.left,y:a.top+a.height},{x:a.left+a.width,y:a.top+a.height},{x:a.left+a.width/2,y:a.top+a.height/2}]}function h(a,b){return a.x>=b[0].x&&a.x<=b[1].x&&a.y>=b[0].y&&a.y<=b[2].y?0:Math.min.apply(Math,b.map(function(b){return(b.x-a.x)*(b.x-a.x)+(b.y-a.y)*(b.y-a.y)}))}var i,j=Object.create(null);return{restrict:"A",controller:["$scope","$attrs","$interpolate","$parse",function(k,l,m,n){var o=m(l.svRoot)(k)||k.$id;j[o]||(j[o]=[]);var p,q,r,s,t,u,v=!1,w=n(l.svOnSort);l.svOnStart=l.$$element[0].attributes["sv-on-start"],l.svOnStart=l.svOnStart&&l.svOnStart.value,l.svOnStop=l.$$element[0].attributes["sv-on-stop"],l.svOnStop=l.svOnStop&&l.svOnStop.value;var x=n(l.svOnStart),y=n(l.svOnStop);if(this.sortingInProgress=function(){return i},l.svGrid){if(null===(v="true"===l.svGrid||"false"!==l.svGrid&&null))throw"Invalid value of sv-grid attribute"}else k.$watchCollection(function(){return c(o)},function(a){v=!1;var b=a.filter(function(a){return!a.container}).map(function(a){return{part:a.getPart().id,y:a.element[0].getBoundingClientRect().top}}),c=Object.create(null);b.forEach(function(a){c[a.part]?c[a.part].push(a.y):c[a.part]=[a.y]}),Object.keys(c).forEach(function(a){c[a].sort(),c[a].forEach(function(b,d){d<c[a].length-1&&b>0&&b===c[a][d+1]&&(v=!0)})})});this.$moveUpdate=function(d,j,l,m,n,w,y){var z=l[0].getBoundingClientRect(),A=a.getScrollingElement();"element"===d.tolerance&&(j={x:~~(z.left+z.width/2),y:~~(z.top+z.height/2)}),i=!0,p=[],q||(n?(q=n.clone(),q.removeClass("ng-hide")):(q=m.clone(),q.addClass("sv-visibility-hidden"),q.addClass("sv-placeholder"),q.css({height:z.height+"px",width:z.width+"px"})),m.after(q),w.copyMode||m.addClass("ng-hide"),t=m,r=d,s=l,x(k,{$helper:{element:s},$part:w.model(w.scope),$index:y,$item:w.model(w.scope)[y]}),k.$root&&k.$root.$$phase||k.$apply()),s[0].reposition({x:j.x+A.scrollLeft-j.offset.x*z.width,y:j.y+A.scrollTop-j.offset.y*z.height}),c(o).forEach(function(a,c){if(null==d.containment||f(a.element,d.containment)||f(a.element,d.containment+" *")){var e=a.element[0].getBoundingClientRect(),i=g(e),k={x:~~(e.left+e.width/2),y:~~(e.top+e.height/2)},l={x:~~(e.left+e.width/2),y:~~e.top},m={x:~~e.left,y:~~(e.top+e.height/2)};if(!a.container&&(a.element[0].scrollHeight||a.element[0].scrollWidth)){var n=a.getPart();p.push({element:a.element,q:h(j,i),view:n,targetIndex:a.getIndex(),after:b(k,j,"isGrid"in n?n.isGrid:v)})}if(a.container&&!a.element[0].querySelector("[sv-element]:not(.sv-placeholder):not(.sv-source)")){var o=k;"vertical"===a.centerVariant?o=m:"horizontal"===a.centerVariant&&(o=l),p.push({element:a.element,q:(o.x-j.x)*(o.x-j.x)+(o.y-j.y)*(o.y-j.y),view:a.getPart(),targetIndex:0,container:!0})}}});var B=q[0].getBoundingClientRect();p.push({q:h(j,g(B)),element:q,placeholder:!0}),p.sort(function(a,b){return a.q-b.q}),p.forEach(function(a,b){0!==b||a.placeholder||a.container?0===b&&a.container?(u=a,a.element.append(q)):a.element.removeClass("sv-candidate"):(u=a,a.element.addClass("sv-candidate"),a.after?a.element.after(q):e(a.element,q))})},this.$drop=function(b,c,d){function e(){if(i=!1,q.remove(),s.remove(),t.removeClass("ng-hide"),p=void 0,q=void 0,d=void 0,s=void 0,t=void 0,y(k,{$part:b.model(b.scope),$index:c,$item:b.model(b.scope)[c]}),u){u.element.removeClass("sv-candidate");var a=b.model(b.scope).splice(c,1),e=u.targetIndex;u.view===b&&u.targetIndex>c&&e--,u.after&&e++,u.view.model(u.view.scope).splice(e,0,a[0]),u.view===b&&c===e||w(k,{$partTo:u.view.model(u.view.scope),$partFrom:b.model(b.scope),$item:a[0],$indexTo:e,$indexFrom:c})}u=void 0,k.$root&&k.$root.$$phase||k.$apply()}if(q)if(!d.revert||u&&u.view&&u.view.noRevert)e();else{var f=q[0].getBoundingClientRect(),g=s[0].getBoundingClientRect(),h=Math.sqrt(Math.pow(g.top-f.top,2)+Math.pow(g.left-f.left,2)),j=a.getScrollingElement(),l=+d.revert*h/200;l=Math.min(l,+d.revert),["-webkit-","-moz-","-ms-","-o-",""].forEach(function(a){void 0!==s[0].style[a+"transition"]&&(s[0].style[a+"transition"]="all "+l+"ms ease")}),setTimeout(e,l),s.css({top:f.top+j.scrollTop+"px",left:f.left+j.scrollLeft+"px"})}},this.addToSortableElements=function(a){c(o).push(a)},this.removeFromSortableElements=function(a){var b=c(o),e=b.indexOf(a);e>-1&&(b.splice(e,1),0===b.length&&d(o))}}]}}]),h.directive("svPart",["$parse",function(a){return{restrict:"A",require:"^svRoot",controller:["$scope",function(a){a.$ctrl=this,this.getPart=function(){return a.part},this.$drop=function(b,c){a.$sortableRoot.$drop(a.part,b,c)}}],scope:!0,link:function(b,c,d,e){if(!d.svPart)throw new Error("no model provided");var f=a(d.svPart);if(!f.assign)throw new Error("model not assignable");b.part={id:b.$id,element:c,model:f,copyMode:"true"===d.svCopy,noRevert:"true"===d.svNoRevert,scope:b},"isGrid"in d&&(b.part.isGrid="true"===d.isGrid),b.$sortableRoot=e;var g={element:c,getPart:b.$ctrl.getPart,container:!0,centerVariant:d.svCenter||"both"};e.addToSortableElements(g),b.$on("$destroy",function(){e.removeFromSortableElements(g)})}}}]),h.directive("svElement",["$parse","svProvider",function(a,d){return{restrict:"A",require:["^svPart","^svRoot"],controller:["$scope",function(a){a.$ctrl=this}],link:function(e,f,g,h){function i(i){function j(a){c(a),o||(f.parent().prepend(s),o=!0),h[1].$moveUpdate(q,{x:a.clientX,y:a.clientY,offset:w},s,f,n,h[0].getPart(),e.$index)}if(c(i),!h[1].sortingInProgress()&&(0==i.button||"mousedown"!==i.type)){var l=i.target.attributes["sv-handle-disabled"];if(!l||"true"!==l.value){o=!1;var q=a(g.svElement)(e);if(q=b.extend({},{tolerance:"pointer",revert:200,containment:"html"},q),q.containment)var r=k.call(f,q.containment)[0].getBoundingClientRect();var s,t=f,u=f[0].getBoundingClientRect(),v=d.getScrollingElement();m||(m=h[0].helper),n||(n=h[0].placeholder),m?(s=m.clone(),s.removeClass("ng-hide"),s.css({left:u.left+v.scrollLeft+"px",top:u.top+v.scrollTop+"px"}),t.addClass("sv-visibility-hidden")):(s=t.clone(),s.addClass("sv-helper").css({left:u.left+v.scrollLeft+"px",top:u.top+v.scrollTop+"px",width:u.width+"px"})),s[0].reposition=function(a){var b=a.x,c=a.y,d=s[0].getBoundingClientRect();r&&(c<r.top+v.scrollTop&&(c=r.top+v.scrollTop),c+d.height>r.top+v.scrollTop+r.height&&(c=r.top+v.scrollTop+r.height-d.height),b<r.left+v.scrollLeft&&(b=r.left+v.scrollLeft),b+d.width>r.left+v.scrollLeft+r.width&&(b=r.left+v.scrollLeft+r.width-d.width)),this.style.left=b-v.scrollLeft+"px",this.style.top=c-v.scrollTop+"px"};var w={x:(i.clientX-u.left)/u.width,y:(i.clientY-u.top)/u.height};p.addClass("sv-sorting-in-progress"),p.on("mousemove touchmove",j).on("mouseup touchend touchcancel",function a(b){p.off("mousemove touchmove",j),p.off("mouseup touchend touchcancel",a),p.removeClass("sv-sorting-in-progress"),o&&h[0].$drop(e.$index,q),f.removeClass("sv-visibility-hidden")})}}}var j={element:f,getPart:h[0].getPart,getIndex:function(){return e.$index}};h[1].addToSortableElements(j),e.$on("$destroy",function(){h[1].removeFromSortableElements(j)});var l=f;l.on("mousedown touchstart",i),e.$watch("$ctrl.handle",function(a){a&&(l.off("mousedown touchstart",i),l=a,l.on("mousedown touchstart",i))});var m;e.$watch("$ctrl.helper",function(a){a&&(m=a)});var n;e.$watch("$ctrl.placeholder",function(a){a&&(n=a)});var o,p=(b.element(document.body),b.element(document.documentElement))}}}]),h.directive("svHandle",function(){return{require:"?^svElement",link:function(a,b,c,d){d&&(d.handle=b.add(d.handle))}}}),h.directive("svHelper",function(){return{require:["?^svPart","?^svElement"],link:function(a,b,c,d){b.addClass("sv-helper").addClass("ng-hide"),d[1]?d[1].helper=b:d[0]&&(d[0].helper=b)}}}),h.directive("svPlaceholder",function(){return{require:["?^svPart","?^svElement"],link:function(a,b,c,d){b.addClass("sv-placeholder").addClass("ng-hide"),d[1]?d[1].placeholder=b:d[0]&&(d[0].placeholder=b)}}}),h.provider("sv",function(){var a="";this.getScrollingElement=function(){var b=document;return a?b.querySelector(a):g()},this.setScrollingElement=function(b){b&&("string"==typeof b||b instanceof Node)&&(a=b)}}),b.element(document.head).append(["<style>.sv-helper{position: fixed !important;z-index: 99999;margin: 0 !important;}.sv-candidate{}.sv-placeholder{}.sv-sorting-in-progress{-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;}.sv-visibility-hidden{visibility: hidden !important;opacity: 0 !important;}</style>"].join(""));var i=document.documentElement,j=i.matches?"matches":i.matchesSelector?"matchesSelector":i.webkitMatches?"webkitMatches":i.webkitMatchesSelector?"webkitMatchesSelector":i.msMatches?"msMatches":i.msMatchesSelector?"msMatchesSelector":i.mozMatches?"mozMatches":i.mozMatchesSelector?"mozMatchesSelector":null;if(null==j)throw"This browser doesn't support the HTMLElement.matches method";var k=b.element.prototype.closest||function(a){for(var c=this[0].parentNode;c!==document.documentElement&&!c[j](a);)c=c.parentNode;return c[j](a)?b.element(c):b.element()};"function"!=typeof b.element.prototype.add&&(b.element.prototype.add=function(a){var c,d=b.element();for(a=b.element(a),c=0;c<this.length;c++)d.push(this[c]);for(c=0;c<a.length;c++)d.push(a[c]);return d})}(window,angular);